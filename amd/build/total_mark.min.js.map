{"version":3,"file":"total_mark.min.js","sources":["../src/total_mark.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n//\n\n/**\n * Total mark calculation module for mod_coursework.\n *\n * @module     mod_coursework/total_mark\n * @copyright  2026 UCL\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Update the UI elements.\n *\n * @param {Number} totalScore The current total score.\n * @param {Number} totalMax The maximum possible score.\n */\nconst updateUi = (totalScore, totalMax) => {\n    const score = +totalScore.toFixed(2);\n    const max = +totalMax.toFixed(2);\n    const percent = max > 0 ? (score / max) * 100 : 0;\n    const displayPercent = +Math.max(0, Math.min(percent, 100)).toFixed(2);\n\n    document.querySelectorAll('[data-region=\"total-mark-display\"]').forEach(region => {\n        // Update the text spans.\n        region.querySelector('.total-score-text').textContent = score.toString();\n        region.querySelector('.total-max-text').textContent = max.toString();\n        region.querySelector('.total-percent').textContent = displayPercent.toString();\n\n        // Update the progress bar.\n        const bar = region.querySelector('.total-progress-bar');\n        if (bar) {\n            bar.style.width = displayPercent + '%';\n            bar.setAttribute('aria-valuenow', score.toString());\n            bar.setAttribute('aria-valuemax', max.toString());\n        }\n    });\n};\n\n/**\n * Calculate totals for Rubric.\n */\nconst calculateRubric = () => {\n    const rubric = document.querySelector('.gradingform_rubric');\n    if (!rubric) {\n        return;\n    }\n\n    let runningTotal = 0;\n    let runningMax = 0;\n\n    rubric.querySelectorAll('.criterion').forEach(row => {\n        const selected = row.querySelector('.level.checked .scorevalue');\n        if (selected) {\n            runningTotal += parseFloat(selected.textContent) || 0;\n        }\n\n        let rowMax = 0;\n        row.querySelectorAll('.scorevalue').forEach(span => {\n            const val = parseFloat(span.textContent) || 0;\n            if (val > rowMax) {\n                rowMax = val;\n            }\n        });\n        runningMax += rowMax;\n    });\n\n    updateUi(runningTotal, runningMax);\n};\n\n/**\n * Calculate totals for Marking Guide.\n */\nconst calculateGuide = () => {\n    const guide = document.querySelector('.gradingform_guide');\n    if (!guide) {\n        return;\n    }\n\n    let runningTotal = 0;\n    let runningMax = 0;\n\n    guide.querySelectorAll('.score input:not(.input-percent)[type=\"number\"]').forEach(input => {\n        const val = parseFloat(input.value);\n        const max = parseFloat(input.getAttribute('max'));\n        if (!isNaN(val)) {\n            runningTotal += Math.min(val, max);\n        }\n        if (!isNaN(max)) {\n            runningMax += max;\n        }\n    });\n\n    updateUi(runningTotal, runningMax);\n};\n\n/**\n * Initialize the grading tracker listeners.\n */\nconst initGradingTracker = () => {\n    const rubric = document.querySelector('.gradingform_rubric');\n    const guide = document.querySelector('.gradingform_guide');\n\n    if (rubric) {\n        const observer = new MutationObserver(calculateRubric);\n        observer.observe(rubric, {\n            attributes: true,\n            subtree: true,\n            attributeFilter: ['class']\n        });\n        calculateRubric();\n    }\n\n    if (guide) {\n        document.addEventListener('input', (e) => {\n            if (e.target.closest('.gradingform_guide .score')) {\n                calculateGuide();\n            }\n        });\n        calculateGuide();\n    }\n};\n\n/**\n * Init.\n */\nexport const init = () => {\n    const run = () => {\n        // A tiny 50ms delay to let the DOM settle.\n        setTimeout(() => {\n            initGradingTracker();\n        }, 50);\n    };\n\n    if (document.readyState === 'complete') {\n        run();\n    } else {\n        window.addEventListener('load', run);\n    }\n};"],"names":["updateUi","totalScore","totalMax","score","toFixed","max","percent","displayPercent","Math","min","document","querySelectorAll","forEach","region","querySelector","textContent","toString","bar","style","width","setAttribute","calculateRubric","rubric","runningTotal","runningMax","row","selected","parseFloat","rowMax","span","val","calculateGuide","guide","input","value","getAttribute","isNaN","run","setTimeout","MutationObserver","observe","attributes","subtree","attributeFilter","addEventListener","e","target","closest","initGradingTracker","readyState","window"],"mappings":";;;;;;;;MA8BMA,SAAW,CAACC,WAAYC,kBACpBC,OAASF,WAAWG,QAAQ,GAC5BC,KAAOH,SAASE,QAAQ,GACxBE,QAAUD,IAAM,EAAKF,MAAQE,IAAO,IAAM,EAC1CE,gBAAkBC,KAAKH,IAAI,EAAGG,KAAKC,IAAIH,QAAS,MAAMF,QAAQ,GAEpEM,SAASC,iBAAiB,sCAAsCC,SAAQC,SAEpEA,OAAOC,cAAc,qBAAqBC,YAAcZ,MAAMa,WAC9DH,OAAOC,cAAc,mBAAmBC,YAAcV,IAAIW,WAC1DH,OAAOC,cAAc,kBAAkBC,YAAcR,eAAeS,iBAG9DC,IAAMJ,OAAOC,cAAc,uBAC7BG,MACAA,IAAIC,MAAMC,MAAQZ,eAAiB,IACnCU,IAAIG,aAAa,gBAAiBjB,MAAMa,YACxCC,IAAIG,aAAa,gBAAiBf,IAAIW,iBAQ5CK,gBAAkB,WACdC,OAASZ,SAASI,cAAc,2BACjCQ,kBAIDC,aAAe,EACfC,WAAa,EAEjBF,OAAOX,iBAAiB,cAAcC,SAAQa,YACpCC,SAAWD,IAAIX,cAAc,8BAC/BY,WACAH,cAAgBI,WAAWD,SAASX,cAAgB,OAGpDa,OAAS,EACbH,IAAId,iBAAiB,eAAeC,SAAQiB,aAClCC,IAAMH,WAAWE,KAAKd,cAAgB,EACxCe,IAAMF,SACNA,OAASE,QAGjBN,YAAcI,UAGlB5B,SAASuB,aAAcC,aAMrBO,eAAiB,WACbC,MAAQtB,SAASI,cAAc,0BAChCkB,iBAIDT,aAAe,EACfC,WAAa,EAEjBQ,MAAMrB,iBAAiB,mDAAmDC,SAAQqB,cACxEH,IAAMH,WAAWM,MAAMC,OACvB7B,IAAMsB,WAAWM,MAAME,aAAa,QACrCC,MAAMN,OACPP,cAAgBf,KAAKC,IAAIqB,IAAKzB,MAE7B+B,MAAM/B,OACPmB,YAAcnB,QAItBL,SAASuB,aAAcC,2BAiCP,WACVa,IAAM,KAERC,YAAW,KA9BQ,YACjBhB,OAASZ,SAASI,cAAc,uBAChCkB,MAAQtB,SAASI,cAAc,sBAEjCQ,SACiB,IAAIiB,iBAAiBlB,iBAC7BmB,QAAQlB,OAAQ,CACrBmB,YAAY,EACZC,SAAS,EACTC,gBAAiB,CAAC,WAEtBtB,mBAGAW,QACAtB,SAASkC,iBAAiB,SAAUC,IAC5BA,EAAEC,OAAOC,QAAQ,8BACjBhB,oBAGRA,mBAWIiB,KACD,KAGqB,aAAxBtC,SAASuC,WACTZ,MAEAa,OAAON,iBAAiB,OAAQP"}