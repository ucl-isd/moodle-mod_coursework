{"version":3,"file":"turnitin_similarity_fetcher.min.js","sources":["../src/turnitin_similarity_fetcher.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport Ajax from \"../../../../lib/amd/src/ajax\";\nimport {getString} from 'core/str';\nimport Log from 'core/log';\n\nlet courseworkId;\n\n/**\n * Javascript module for handling fetching of similarity data from TII after page load.\n *\n * @module      mod_coursework/turnitin_similarity_fetcher\n * @copyright   2025 UCL\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Find all submission files currently visible in the UI where TII links are not yet loaded, get the links and add to UI.\n * Designed to be called on each scroll event to check and load any unloaded submissions presently in view.\n * (I.e. avoid loading hundreds of submissions at the outset where some may never be viewed).\n * @type {(function(...[*]): void)|*}\n */\nconst processTurnitin = debounce(\n    async() => {\n        const plagiarismLinks = [...document.querySelectorAll('.mod-coursework-plagiarism-tii-links')];\n        const visiblePlagiarismLinks = plagiarismLinks\n            .filter(el => {\n                return el.dataset.tiiLoaded === \"false\";\n            })\n            .filter(el => { // Only if currently in view\n                const {top, bottom, left, right} = el.getBoundingClientRect();\n                return top >= 0 && bottom <= window.innerHeight && left >= 0 && right <= window.innerWidth;\n            });\n        const submissionIds = visiblePlagiarismLinks.map(elem => {\n            return parseInt(elem.closest('.mod-coursework-submissions-submission-col').dataset.submissionId);\n        });\n\n        if (submissionIds.length) {\n            const WSResult = await Ajax.call([{\n                methodname: 'mod_coursework_get_turnitin_similarity_links',\n                args: {courseworkid: courseworkId, submissionids: submissionIds}\n            }])[0];\n            const tiiEmptyString = await getString('turnitinnoreport', 'coursework');\n            if (WSResult.success) {\n                WSResult.result.forEach(submission => {\n                    submission.files.forEach(file => {\n                        const el = document.getElementById('mod-coursework-plagiarism-tii-links-' + file.fileid);\n                        if (el) {\n                            el.innerHTML = file.linkshtml;\n                            if (el.innerHTML === '') {\n                                el.innerHTML = `<small>${tiiEmptyString}</small>`;\n                            }\n                            el.dataset.tiiLoaded = \"true\";\n                        } else {\n                            Log.debug(\"Element not found #mod-coursework-plagiarism-tii-links-\" + file.fileid);\n                        }\n                    });\n                });\n            } else {\n                Log.debug(\n                    \"Error getting Turnitin links for submissions \" + submissionIds.join(',')\n                    + \": \" + WSResult.errorcode + \" | \" + WSResult.message\n                );\n                submissionIds.forEach(id => {\n                    const elems = document.querySelectorAll(\n                        `.mod-coursework-submissions-submission-col[data-submission-id=\"${id}\"]`\n                            + `.mod-coursework-plagiarism-tii-links`\n                    );\n                    elems.forEach(el => {\n                        el.innerHTML = `<small>${tiiEmptyString}</small>`;\n                        el.dataset.tiiLoaded = \"true\";\n                    });\n                });\n            }\n        }\n    },\n    100\n);\n\n/**\n * To improve performance avoid repeatedly running the provided fn on every scroll event.\n * @param {function} fn\n * @param {number} delay\n * @returns {(function(...[*]): void)|*}\n */\nfunction debounce(fn, delay = 100) {\n    let timerId;\n    return function(...args) {\n        clearTimeout(timerId);\n        timerId = setTimeout(() => fn.apply(this, args), delay);\n    };\n}\n\n/**\n * Initialize module.\n * @param {number} courseworkid the coursework ID.\n */\nexport const init = (courseworkid) => {\n    courseworkId = courseworkid;\n    window.addEventListener(\"scrollend\", processTurnitin, {passive: true});\n    processTurnitin();\n};\n"],"names":["courseworkId","processTurnitin","fn","timerId","delay","args","clearTimeout","setTimeout","apply","this","debounce","async","submissionIds","document","querySelectorAll","filter","el","dataset","tiiLoaded","top","bottom","left","right","getBoundingClientRect","window","innerHeight","innerWidth","map","elem","parseInt","closest","submissionId","length","WSResult","Ajax","call","methodname","courseworkid","submissionids","tiiEmptyString","success","result","forEach","submission","files","file","getElementById","fileid","innerHTML","linkshtml","debug","join","errorcode","message","id","addEventListener","passive"],"mappings":"+OAmBIA;;;;;;;8JAgBEC,yBA+DYC,QACVC,QADcC,6DAAQ,WAEnB,yCAAYC,6CAAAA,2BACfC,aAAaH,SACbA,QAAUI,YAAW,IAAML,GAAGM,MAAMC,KAAMJ,OAAOD,QAnEjCM,EACpBC,gBAUUC,cATkB,IAAIC,SAASC,iBAAiB,yCAEjDC,QAAOC,IAC4B,UAAzBA,GAAGC,QAAQC,YAErBH,QAAOC,WACEG,IAACA,IAADC,OAAMA,OAANC,KAAcA,KAAdC,MAAoBA,OAASN,GAAGO,+BAC/BJ,KAAO,GAAKC,QAAUI,OAAOC,aAAeJ,MAAQ,GAAKC,OAASE,OAAOE,cAE3CC,KAAIC,MACtCC,SAASD,KAAKE,QAAQ,8CAA8Cb,QAAQc,mBAGnFnB,cAAcoB,OAAQ,OAChBC,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,+CACZ/B,KAAM,CAACgC,aAAcrC,aAAcsC,cAAe1B,kBAClD,GACE2B,qBAAuB,kBAAU,mBAAoB,cACvDN,SAASO,QACTP,SAASQ,OAAOC,SAAQC,aACpBA,WAAWC,MAAMF,SAAQG,aACf7B,GAAKH,SAASiC,eAAe,uCAAyCD,KAAKE,QAC7E/B,IACAA,GAAGgC,UAAYH,KAAKI,UACC,KAAjBjC,GAAGgC,YACHhC,GAAGgC,2BAAsBT,4BAE7BvB,GAAGC,QAAQC,UAAY,qBAEnBgC,MAAM,0DAA4DL,KAAKE,4BAKnFG,MACA,gDAAkDtC,cAAcuC,KAAK,KACnE,KAAOlB,SAASmB,UAAY,MAAQnB,SAASoB,SAEnDzC,cAAc8B,SAAQY,KACJzC,SAASC,iBACnB,yEAAkEwC,iDAGhEZ,SAAQ1B,KACVA,GAAGgC,2BAAsBT,2BACzBvB,GAAGC,QAAQC,UAAY,iBAM3C,mBAqBiBmB,eACjBrC,aAAeqC,aACfb,OAAO+B,iBAAiB,YAAatD,gBAAiB,CAACuD,SAAS,IAChEvD"}