{"version":3,"file":"marking_guide_feedback_percent.min.js","sources":["../src/marking_guide_feedback_percent.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript module for marking guide feedback form percentages helper.\n *\n * @module      mod_coursework/marking_guide_feedback_percent\n * @copyright   2026 UCL\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nconst CLASS_PERCENT_INPUT = 'input-percent';\nconst MAX_VALUE_PERCENT = 100;\nconst MAX_PERCENT_LENGTH = 5; // Including decimals.\nimport {getString} from 'core/str';\nimport Ajax from 'core/ajax';\n\nlet usingPercentGrades;\n\nconst getDecimalPlaces = () => {\n    return 2;\n};\n\nconst getFieldName = (criterionNumber, isPercent) => {\n    return `advancedgrading-criteria-${criterionNumber}-` + (isPercent ? 'percent' : 'score');\n};\n\nconst handleCheckBoxClick = async () => {\n    const checkBox = event.target;\n    usingPercentGrades = checkBox.checked;\n\n    const percentFields = document.querySelectorAll('table#advancedgrading-criteria .input-percent');\n    percentFields.forEach((elem) => {\n        if (!usingPercentGrades) {\n            elem.setAttribute('readonly', true);\n        } else {\n            elem.removeAttribute('readonly');\n        }\n    });\n\n    const nonPercentFields = document.querySelectorAll('table#advancedgrading-criteria input:not(.input-percent)');\n    nonPercentFields.forEach((elem) => {\n        if (usingPercentGrades) {\n            elem.setAttribute('readonly', true);\n        } else {\n            elem.removeAttribute('readonly');\n        }\n    });\n\n    // Update user preference on server.\n    const request = {\n        methodname: 'core_user_update_user_preferences',\n        args: {\n            preferences: [\n                {\n                    type: \"coursework_guide_enter_percent_grades\",\n                    value: checkBox.checked ? 1 : 0,\n                }\n            ]\n        }\n    };\n    await Ajax.call([request])[0];\n};\n\n/**\n * Initialise\n * @param {bool} initialPreferenceValue\n */\nexport const init = (initialPreferenceValue) => {\n    usingPercentGrades = initialPreferenceValue;\n\n    // Watch the \"Enter grades as %\" checkbox.\n    const checkBox = document.querySelector('input[data-action=\"coursework-set-pref-grades-as-percent\"]');\n    const criteriaTable = document.getElementById('advancedgrading-criteria');\n    if (criteriaTable && checkBox) {\n        checkBox.addEventListener('input', handleCheckBoxClick);\n    }\n\n    (async() => {\n        const markPercentString = await getString('markpercent', 'coursework');\n        const tableCells = document.querySelectorAll('div#guide-advancedgrading tr.criterion td.score');\n        tableCells.forEach((tableCell) => {\n            const scoreInputElem = tableCell.querySelector('input');\n            const criterionNumber = scoreInputElem.name.match(/advancedgrading\\[criteria]\\[(\\d+)]\\[score]/)[1] ?? null;\n            const newFieldName = getFieldName(criterionNumber, true);\n            const scoreOutOf = parseInt(scoreInputElem.max);\n\n            // Add score as data attr to existing (core) score input, and prevent edits if using percent instead.\n            scoreInputElem.setAttribute('data-criterion-number', criterionNumber);\n            if (usingPercentGrades) {\n                scoreInputElem.setAttribute('readonly', 'true');\n            }\n\n            scoreInputElem.addEventListener('input', handleScoreChangeEvent);\n\n            // New percentage <input>.\n            const inp = document.createElement('input');\n            inp.name = newFieldName;\n            inp.classList.add(\"form-control\");\n            inp.classList.add(CLASS_PERCENT_INPUT, 'mb-2');\n            inp.id = newFieldName;\n            inp.setAttribute('data-criterion-number', criterionNumber);\n            inp.setAttribute('type', \"text\");\n            inp.setAttribute('inputmode', \"decimal\");\n            inp.setAttribute('size', MAX_PERCENT_LENGTH - 1);\n            inp.setAttribute('min', 0);\n            inp.setAttribute('max', MAX_VALUE_PERCENT);\n            inp.setAttribute('step', 1 / (Math.pow(10, getDecimalPlaces())));\n            if (!usingPercentGrades) {\n                inp.setAttribute('readonly', true);\n            }\n            tableCell.insertBefore(inp, tableCell.firstChild);\n            inp.addEventListener('input', handlePercentChangeEvent);\n            inp.addEventListener('keypress', preventInvalidNumber);\n\n            // New <label> for new percentage input.\n            const label = document.createElement('label');\n            label.setAttribute('for', newFieldName);\n            label.classList.add('text-right');\n            label.textContent = markPercentString;\n            tableCell.insertBefore(label, tableCell.firstChild);\n\n            if (scoreInputElem.value !== '') {\n                setPercentageFromScore(criterionNumber, Number(scoreInputElem.value), scoreOutOf);\n            }\n        });\n    })();\n};\n\n/**\n * If the value is a whole number ignoring any tiny decimals, display it as such e.g. 10 not 10.00\n * @param {number} value\n * @returns {string}\n */\nconst applyRounding = (value) => {\n    return Math.abs(value.toFixed(getDecimalPlaces()) - Math.floor(value)) === 0\n        ? value.toFixed(0) : value.toFixed(getDecimalPlaces());\n};\n\nconst setPercentageFromScore = (criterionNumber, scoreValue, scoreOutOf) => {\n    const percentElem = document.getElementById(getFieldName(criterionNumber, true));\n    if (scoreValue === '') {\n        percentElem.value = '';\n        return;\n    }\n    percentElem.value = applyRounding(scoreValue / scoreOutOf * MAX_VALUE_PERCENT);\n};\n\nconst setScoreFromPercent = (criterionNumber, percentValue) => {\n    const scoreInputElem = document.getElementById(getFieldName(criterionNumber, false));\n    scoreInputElem.value = percentValue === ''\n        ? ''\n        : ((Number(scoreInputElem.max) * percentValue) / MAX_VALUE_PERCENT).toFixed(getDecimalPlaces());\n    scoreInputElem.classList.remove('invalid-value');\n};\n\nconst preventInvalidNumber = (event) => {\n    // Field will allow user to enter e for scientific notation - stop that.\n    if (!/[0-9.]/.test(event.key)) {\n        event.preventDefault();\n        return;\n    }\n    const maxLength = event.target.value.includes('.')\n        ? MAX_PERCENT_LENGTH : MAX_PERCENT_LENGTH - 1;\n    const hasSelectedText = event.target.selectionStart !== event.target.selectionEnd;\n    if (\n        !hasSelectedText\n        && event.target.value.length >= maxLength\n        && event.key !== 'Backspace'\n        && event.key !== 'Delete'\n    ) {\n        event.preventDefault();\n    }\n};\n\nconst handleScoreChangeEvent = (event) => {\n    const criterionNumber = Number(event.target.getAttribute('data-criterion-number'));\n    const scoreOutOf = Number(event.target.max);\n    if (event.target.value === '') {\n        setPercentageFromScore(criterionNumber, '');\n        return;\n    }\n    // User may enter out of range values so ensure new value is in range 0 to out of.\n    const newValue = Math.max(Math.min(event.target.value, parseInt(event.target.max)), 0);\n    if (newValue !== Number(event.target.value)) {\n        // If user entered an out of range percentage, warn them.\n        event.target.classList.add('invalid-value');\n    } else {\n        event.target.classList.remove('invalid-value');\n    }\n    setPercentageFromScore(criterionNumber, newValue, scoreOutOf);\n};\n\nconst handlePercentChangeEvent = (event) => {\n    const criterionNumber = Number(event.target.getAttribute('data-criterion-number'));\n    if (event.target.value === '') {\n        setScoreFromPercent(criterionNumber, '');\n        return;\n    }\n    // User may enter out of range values e.g. 120% so ensure new value is in range 0 - MAX_VALUE_PERCENT.\n    const newValue = Math.max(Math.min(Number(event.target.value), MAX_VALUE_PERCENT), 0);\n    if (newValue !== Number(event.target.value)) {\n        // If user entered an out of range percentage, warn them.\n        event.target.classList.add('invalid-value');\n    } else {\n        event.target.classList.remove('invalid-value');\n    }\n    setScoreFromPercent(criterionNumber, newValue);\n};\n"],"names":["usingPercentGrades","getFieldName","criterionNumber","isPercent","handleCheckBoxClick","async","checkBox","event","target","checked","document","querySelectorAll","forEach","elem","removeAttribute","setAttribute","request","methodname","args","preferences","type","value","Ajax","call","initialPreferenceValue","querySelector","getElementById","addEventListener","markPercentString","tableCell","scoreInputElem","name","match","newFieldName","scoreOutOf","parseInt","max","handleScoreChangeEvent","inp","createElement","classList","add","id","MAX_PERCENT_LENGTH","Math","pow","insertBefore","firstChild","handlePercentChangeEvent","preventInvalidNumber","label","textContent","setPercentageFromScore","Number","scoreValue","percentElem","abs","toFixed","floor","setScoreFromPercent","percentValue","remove","test","key","preventDefault","maxLength","includes","selectionStart","selectionEnd","length","getAttribute","newValue","min"],"mappings":"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"}