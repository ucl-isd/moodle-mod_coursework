
{{!
    This file is part of Moodle - http://moodle.org/
    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}

<div id="pdf-container" class="mx-auto">

    {{! Submissions metadata. }}
    {{> mod_coursework/submissions/tr/submissions }}

    {{! Pdf viewer. }}
    <div id="pdf-viewer" class="container border m-0 p-0"></div>
</div>

{{! TODO - move css. }}
<style>
.mod-coursework-submission {
  display: flex;
  .mod-coursework-submission-metadata {
    margin-left: auto;
  }
}

#pdf-container {
  max-width: 850px !important;
  #pdf-viewer {
    overflow: scroll;
    margin-top: 1rem !important;
  }
  .pdf-page-canvas {
    max-width: 100% !important;
  }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
// Setting the Worker Source (required for PDF.js to function)
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";

const pdfurl = "{{{pdfurl}}}";
const scalefactor = 1;
const viewercontainer = document.getElementById("pdf-viewer");

// Render pdf onto canvas element.
function renderpage(pdf, pagenum, canvas) {
  pdf.getPage(pagenum).then(function (page) {
    const viewport = page.getViewport({ scale: scalefactor });
    const context = canvas.getContext("2d");

    canvas.height = viewport.height;
    canvas.width = viewport.width;

    const rendercontext = {
      canvasContext: context,
      viewport: viewport
    };
    page.render(rendercontext);
  });
}

// Asynchronously download PDF and render all pages.
pdfjsLib
  .getDocument(pdfurl)
  .promise.then(function (pdfdoc) {
    // Loop through all pages.
    for (let pagenum = 1; pagenum <= pdfdoc.numPages; pagenum++) {
      const canvas = document.createElement("canvas");

      // Append the canvas to the viewer container.
      viewercontainer.appendChild(canvas);

      // Render the specific page onto the new canvas.
      renderpage(pdfdoc, pagenum, canvas);
    }
  })
  .catch(function (error) {
    console.error("Error loading PDF:", error);
  });
</script>